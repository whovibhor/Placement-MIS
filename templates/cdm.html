<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CDM — Placement MIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Placement MIS</a>
            <div class="global-search-wrap ms-auto me-3">
                <input type="text" id="globalSearch" class="form-control form-control-sm"
                    placeholder="Search companies..." autocomplete="off">
                <div id="globalSearchResults" class="global-search-dropdown"></div>
            </div>
            <div class="navbar-nav">
                <a class="nav-link" href="{{ url_for('upload') }}">Upload</a>
                <a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('data_page') }}">Data</a>
                <a class="nav-link active" href="{{ url_for('cdm_page') }}">CDM</a>
                <a class="nav-link" href="{{ url_for('versions') }}">Versions</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4 px-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h3 class="mb-0">Company Data Management</h3>
            <div class="d-flex gap-2">
                <button id="btnAddCompany" class="btn btn-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16" class="me-1">
                        <path
                            d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                    </svg>Add Company
                </button>
                <a href="{{ url_for('cdm_import') }}" class="btn btn-sm btn-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                        viewBox="0 0 16 16" class="me-1">
                        <path
                            d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                        <path
                            d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z" />
                    </svg>Import Excel
                </a>
                <button id="btnExportCDM" class="btn btn-sm btn-outline-light">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                        viewBox="0 0 16 16" class="me-1">
                        <path
                            d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                        <path
                            d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
                    </svg>Export Excel
                </button>
                <div class="dropdown d-inline-block">
                    <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="cdmColToggleBtn"
                        data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                        Columns
                    </button>
                    <div class="dropdown-menu dropdown-menu-dark p-2" id="cdmColToggleMenu"
                        style="min-width:220px;max-height:400px;overflow-y:auto;">
                        <div class="d-flex gap-2 mb-2">
                            <button class="btn btn-xs btn-outline-light flex-fill" id="cdmColShowAll">Show All</button>
                            <button class="btn btn-xs btn-outline-light flex-fill" id="cdmColMinimal">Minimal</button>
                        </div>
                        <div id="cdmColCheckboxes"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-3">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- ── Tab Navigation ──────────────────────────────── -->
        <ul class="nav nav-tabs mb-3" id="cdmTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="drives-tab" data-bs-toggle="tab" data-bs-target="#drivesPane"
                    type="button" role="tab">Drives</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendarPane"
                    type="button" role="tab">Calendar</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sourcesPane"
                    type="button" role="tab">Placement Sources</button>
            </li>
        </ul>

        <div class="tab-content" id="cdmTabContent">
            <!-- ═══════════════ DRIVES TAB ═══════════════ -->
            <div class="tab-pane fade show active" id="drivesPane" role="tabpanel">

                <!-- Compact Summary Bar -->
                <div class="cdm-summary-bar mb-3">
                    <span class="cdm-summary-item" id="sumAll"><strong id="cnt-all">0</strong> Drives</span>
                    <span class="cdm-summary-sep">&middot;</span>
                    <span class="cdm-summary-item cdm-summary-filter" data-filter="all">All</span>
                    <span class="cdm-summary-sep">|</span>
                    <span class="cdm-summary-item cdm-summary-filter cdm-summary-filter--active" data-filter="all"
                        style="display:none;"></span>
                    <span class="cdm-summary-item cdm-summary-filter" data-filter="upcoming"><span
                            id="cnt-upcoming">0</span> Upcoming</span>
                    <span class="cdm-summary-sep">|</span>
                    <span class="cdm-summary-item cdm-summary-filter" data-filter="ongoing"><span
                            id="cnt-ongoing">0</span> Ongoing</span>
                    <span class="cdm-summary-sep">|</span>
                    <span class="cdm-summary-item cdm-summary-filter" data-filter="completed"><span
                            id="cnt-completed">0</span> Completed</span>
                    <span class="cdm-summary-sep">|</span>
                    <span class="cdm-summary-item cdm-summary-filter" data-filter="cancelled"><span
                            id="cnt-cancelled">0</span> Cancelled</span>
                    <span class="cdm-summary-sep">&middot;</span>
                    <span class="cdm-summary-item cdm-summary-filter" data-filter="oncampus"><span
                            id="cnt-oncampus">0</span> On-Campus</span>
                    <span class="cdm-summary-sep">|</span>
                    <span class="cdm-summary-item cdm-summary-filter" data-filter="virtual"><span
                            id="cnt-virtual">0</span> Virtual</span>
                </div>

                <!-- ── Companies List ──────────────────────── -->
                <div class="cdm-companies-section mb-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="cdm-companies-title">
                            Companies <span class="cdm-companies-count" id="companiesCount"></span>
                        </div>
                        <button class="btn btn-xs btn-outline-light" id="toggleCompanies" title="Toggle companies list">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor"
                                viewBox="0 0 16 16" class="me-1">
                                <path
                                    d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                            </svg>
                            <span id="toggleCompaniesText">Show</span>
                        </button>
                    </div>
                    <div id="companiesListWrap" style="display:none;">
                        <div class="cdm-companies-grid" id="companiesGrid"></div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="table-section">
                    <div class="table-section-hint">Click company name to view details &bull; Click any cell to edit
                    </div>
                    <div class="table-responsive">
                        <table id="cdmTable" class="table table-striped table-bordered table-hover" style="width:100%">
                            <thead>
                                <tr id="headerRow"></tr>
                                <tr id="filterRow"></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ═══════════════ CALENDAR TAB ═══════════════ -->
            <div class="tab-pane fade" id="calendarPane" role="tabpanel">
                <div class="d-flex align-items-center mb-3">
                    <button class="btn btn-sm btn-outline-light me-2" id="calPrev">&larr;</button>
                    <h5 class="mb-0" id="calMonthLabel"></h5>
                    <button class="btn btn-sm btn-outline-light ms-2" id="calNext">&rarr;</button>
                </div>
                <div id="calendarGrid" class="cdm-calendar-grid"></div>
            </div>

            <!-- ═══════════════ PLACEMENT SOURCES TAB ═══════════════ -->
            <div class="tab-pane fade" id="sourcesPane" role="tabpanel">
                <div class="stat-cards-row mb-3" id="sourceStats"></div>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="dash-section">
                            <div class="dash-section-title">Top Placement Sources</div>
                            <canvas id="chartSources" height="300"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dash-section">
                            <div class="dash-section-title">Avg CTC by Company</div>
                            <canvas id="chartSourceCTC" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="dash-section mt-4">
                    <div class="dash-section-title">Placement Source Details</div>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover" style="font-size:0.85rem;"
                            id="sourcesTable">
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Students Placed</th>
                                    <th>Avg CTC</th>
                                    <th>Max CTC</th>
                                    <th>Courses</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ── Add Company Modal ──────────────────────────── -->
    <div class="modal fade" id="addCompanyModal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content"
                style="background:var(--bg-card);border:1px solid var(--border-color);color:var(--text-primary);">
                <div class="modal-header border-0 pb-0">
                    <h6 class="modal-title">Add New Company</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="newCompanyName" class="form-control form-control-sm mb-2"
                        placeholder="Company name *"
                        style="background:var(--bg-surface);border-color:var(--border-color);color:var(--text-primary);">
                    <div id="addCompanyError" class="text-danger small d-none"></div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-sm btn-danger" id="btnConfirmAddCompany">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ── Inline Edit Toast ──────────────────────────── -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080;">
        <div id="editToast" class="toast align-items-center text-bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="editToastMsg">Saved</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="{{ url_for('static', filename='filterSystem.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script id="cdm-json" type="application/json">{{ drives_json | tojson }}</script>
    <script id="companies-json" type="application/json">{{ companies_json | tojson }}</script>

    <script>
        $(document).ready(function () {

            var DATA_KEYS = [
                'company_name', 'role', 'ctc_text', 'status', 'courses',
                'jd_received_date', 'process_date', 'process_mode',
                'location', 'received_by', 'data_shared', 'notes'
            ];

            var HEADER_MAP = {
                company_name: 'Company', role: 'Position', ctc_text: 'CTC',
                status: 'Status', courses: 'Courses', jd_received_date: 'JD Received',
                process_date: 'Process Date', process_mode: 'Mode',
                location: 'Location', received_by: 'Received By',
                data_shared: 'Data Shared', notes: 'Notes'
            };

            var MINIMAL_COLS = ['company_name', 'role', 'ctc_text', 'status', 'courses', 'process_date', 'process_mode', 'location'];

            var EDITABLE_KEYS = ['role', 'ctc_text', 'status', 'jd_received_date', 'process_date',
                'process_mode', 'location', 'received_by', 'data_shared', 'notes'];

            var DROPDOWN_FIELDS = {
                status: ['Upcoming', 'Ongoing', 'Completed', 'Cancelled'],
                process_mode: ['On-Campus', 'Virtual'],
                data_shared: ['Yes', 'No']
            };

            var RAW_DATA = JSON.parse(document.getElementById('cdm-json').textContent);
            var COMPANIES_DATA = JSON.parse(document.getElementById('companies-json').textContent);

            /* ── Stats ────────────────────────────────────────── */
            function updateStats() {
                var modes = {};
                var statuses = {};
                RAW_DATA.forEach(function (d) {
                    var m = d.process_mode || 'Unknown';
                    modes[m] = (modes[m] || 0) + 1;
                    var s = d.status || 'Upcoming';
                    statuses[s] = (statuses[s] || 0) + 1;
                });
                $('#cnt-all').text(RAW_DATA.length);
                $('#cnt-upcoming').text(statuses['Upcoming'] || 0);
                $('#cnt-ongoing').text(statuses['Ongoing'] || 0);
                $('#cnt-completed').text(statuses['Completed'] || 0);
                $('#cnt-cancelled').text(statuses['Cancelled'] || 0);
                $('#cnt-oncampus').text(modes['On-Campus'] || 0);
                $('#cnt-virtual').text(modes['Virtual'] || 0);
            }
            updateStats();

            /* ── Companies List ───────────────────────────────── */
            function renderCompanies() {
                var $grid = $('#companiesGrid');
                $grid.empty();
                $('#companiesCount').text('(' + COMPANIES_DATA.length + ')');
                COMPANIES_DATA.forEach(function (c) {
                    var badge = c.drive_count > 0
                        ? '<span class="badge bg-secondary ms-1">' + c.drive_count + ' drive' + (c.drive_count > 1 ? 's' : '') + '</span>'
                        : '<span class="badge bg-warning text-dark ms-1">No drives</span>';
                    $grid.append(
                        '<a href="/cdm/company/' + encodeURIComponent(c.company_id) + '" class="cdm-company-chip">' +
                        '<span class="cdm-company-chip-name">' + c.company_name + '</span>' + badge + '</a>'
                    );
                });
            }
            renderCompanies();

            $('#toggleCompanies').on('click', function () {
                var $wrap = $('#companiesListWrap');
                var isVisible = $wrap.is(':visible');
                $wrap.slideToggle(200);
                $('#toggleCompaniesText').text(isVisible ? 'Show' : 'Hide');
            });

            /* ── Generate <th> headers ────────────────────────── */
            var $hr = $('#headerRow');
            DATA_KEYS.forEach(function (k) {
                $hr.append('<th>' + (HEADER_MAP[k] || k) + '</th>');
            });

            /* ── Init filter system ───────────────────────────── */
            var filterApi = initFilterSystem({
                tableSelector: '#cdmTable',
                data: RAW_DATA,
                keys: DATA_KEYS,
                tableConfig: {
                    language: {
                        lengthMenu: "Show _MENU_ records",
                        info: "Showing _START_ to _END_ of _TOTAL_ drives",
                        emptyTable: "No drives found. Import a CDM Excel file first."
                    },
                    createdRow: function (row, data) {
                        var statusIdx = DATA_KEYS.indexOf('status');
                        var statusCell = $(row).find('td').eq(statusIdx);
                        var st = (data.status || 'Upcoming').toLowerCase();
                        var badgeCls = st === 'completed' ? 'bg-success' :
                            st === 'ongoing' ? 'bg-warning text-dark' :
                                st === 'cancelled' ? 'bg-danger' : 'bg-info';
                        statusCell.html('<span class="badge ' + badgeCls + '">' + (data.status || 'Upcoming') + '</span>');
                    }
                }
            });

            /* ── Filter Tiles ─────────────────────────────────── */
            var FILTER_FUNCTIONS = {
                'all': null,
                'upcoming': function (r) { return (r.status || 'Upcoming') === 'Upcoming'; },
                'ongoing': function (r) { return r.status === 'Ongoing'; },
                'completed': function (r) { return r.status === 'Completed'; },
                'cancelled': function (r) { return r.status === 'Cancelled'; },
                'oncampus': function (r) { return r.process_mode === 'On-Campus'; },
                'virtual': function (r) { return r.process_mode === 'Virtual'; }
            };

            var activeFilter = 'all';

            $(document).on('click', '.cdm-summary-filter[data-filter]', function () {
                var filterKey = $(this).data('filter');
                activeFilter = filterKey;
                $('.cdm-summary-filter').removeClass('cdm-summary-filter--active');
                $(this).addClass('cdm-summary-filter--active');
                filterApi.setPreFilter(FILTER_FUNCTIONS[filterKey]);
            });

            /* ── Column Visibility Toggle ─────────────────────── */
            var table = filterApi.getTable();
            var $colMenu = $('#cdmColCheckboxes');

            DATA_KEYS.forEach(function (k, idx) {
                var label = HEADER_MAP[k] || k;
                $colMenu.append(
                    '<div class="form-check mb-1">' +
                    '<input class="form-check-input cdm-col-cb" type="checkbox" checked ' +
                    'data-col="' + idx + '" id="cdmCol' + idx + '">' +
                    '<label class="form-check-label small" for="cdmCol' + idx + '">' + label + '</label>' +
                    '</div>'
                );
            });

            $(document).on('change', '.cdm-col-cb', function () {
                var colIdx = parseInt($(this).data('col'));
                table.column(colIdx).visible($(this).is(':checked'));
            });

            function applyCols(cols) {
                DATA_KEYS.forEach(function (k, i) {
                    var vis = cols.indexOf(k) !== -1;
                    table.column(i).visible(vis);
                    $('.cdm-col-cb[data-col="' + i + '"]').prop('checked', vis);
                });
            }

            $('#cdmColShowAll').on('click', function () { applyCols(DATA_KEYS.slice()); });
            $('#cdmColMinimal').on('click', function () { applyCols(MINIMAL_COLS); });

            /* ══════════════════════════════════════════════════════
               INLINE EDITING
               ══════════════════════════════════════════════════════ */
            function showToast(msg, type) {
                var $t = $('#editToast');
                $t.removeClass('text-bg-success text-bg-danger').addClass('text-bg-' + (type || 'success'));
                $('#editToastMsg').text(msg);
                bootstrap.Toast.getOrCreateInstance($t[0], { delay: 2000 }).show();
            }

            $(document).on('click', '#cdmTable tbody td', function (e) {
                if ($(this).find('input, select').length) return;
                var tbl = $('#cdmTable').DataTable();
                var cell = tbl.cell(this);
                if (!cell || !cell.data) return;
                var colIdx = cell.index().column;
                var key = DATA_KEYS[colIdx];
                var rowData = tbl.row(cell.index().row).data();

                if (key === 'company_name') {
                    if (rowData && rowData.company_id) {
                        window.open('/cdm/company/' + encodeURIComponent(rowData.company_id), '_blank');
                    }
                    return;
                }

                if (key === 'courses') return;
                if (EDITABLE_KEYS.indexOf(key) === -1) return;

                var currentVal = rowData[key] || '';
                var $td = $(this);
                var originalHtml = $td.html();

                if (key === 'status') {
                    currentVal = $td.find('.badge').text() || currentVal;
                }

                if (DROPDOWN_FIELDS[key]) {
                    var opts = DROPDOWN_FIELDS[key].map(function (o) {
                        return '<option value="' + o + '"' + (o === currentVal ? ' selected' : '') + '>' + o + '</option>';
                    }).join('');
                    var $sel = $('<select class="form-select form-select-sm edit-inline-input">' + opts + '</select>');
                    $td.empty().append($sel);
                    $sel.focus();

                    var saved = false;
                    $sel.on('change', function () {
                        if (!saved) { saved = true; saveEdit(rowData.drive_id, key, $sel.val(), $td, originalHtml, rowData, colIdx); }
                    });
                    $sel.on('blur', function () {
                        if (!saved) $td.html(originalHtml);
                    });
                } else {
                    var inputType = (key === 'jd_received_date' || key === 'process_date') ? 'date' : 'text';
                    var $inp = $('<input type="' + inputType + '" class="form-control form-control-sm edit-inline-input" value="' +
                        $('<i>').text(currentVal).html() + '">');
                    $td.empty().append($inp);
                    $inp.focus().select();

                    $inp.on('keydown', function (ev) {
                        if (ev.key === 'Enter') {
                            saveEdit(rowData.drive_id, key, $inp.val(), $td, originalHtml, rowData, colIdx);
                        } else if (ev.key === 'Escape') {
                            $td.html(originalHtml);
                        }
                    });
                    $inp.on('blur', function () {
                        var newVal = $inp.val();
                        if (newVal !== currentVal) {
                            saveEdit(rowData.drive_id, key, newVal, $td, originalHtml, rowData, colIdx);
                        } else {
                            $td.html(originalHtml);
                        }
                    });
                }
            });

            function saveEdit(driveId, field, value, $td, originalHtml, rowData, colIdx) {
                $.ajax({
                    url: '/api/cdm/drive/' + driveId,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ field: field, value: value }),
                    success: function (res) {
                        if (res.ok) {
                            var displayVal = res.value != null ? res.value : '';
                            rowData[field] = displayVal;
                            for (var i = 0; i < RAW_DATA.length; i++) {
                                if (RAW_DATA[i].drive_id == driveId) {
                                    RAW_DATA[i][field] = String(displayVal);
                                    break;
                                }
                            }
                            if (field === 'status') {
                                var st = displayVal.toLowerCase();
                                var badgeCls = st === 'completed' ? 'bg-success' :
                                    st === 'ongoing' ? 'bg-warning text-dark' :
                                        st === 'cancelled' ? 'bg-danger' : 'bg-info';
                                $td.html('<span class="badge ' + badgeCls + '">' + displayVal + '</span>');
                            } else {
                                $td.text(displayVal);
                            }
                            showToast('Saved: ' + (HEADER_MAP[field] || field), 'success');
                            if (field === 'status' || field === 'process_mode') updateStats();
                        } else {
                            $td.html(originalHtml);
                            showToast('Error: ' + (res.error || 'Unknown'), 'danger');
                        }
                    },
                    error: function (xhr) {
                        $td.html(originalHtml);
                        var msg = 'Save failed';
                        try { msg = JSON.parse(xhr.responseText).error || msg; } catch (e) { }
                        showToast(msg, 'danger');
                    }
                });
            }

            /* ── Export Excel ──────────────────────────────────── */
            $('#btnExportCDM').on('click', function () {
                var data = filterApi.getCurrentData();
                if (!data || !data.length) { alert('No data to export.'); return; }

                var headers = DATA_KEYS.map(function (k) { return HEADER_MAP[k] || k; });
                var aoa = [headers];
                data.forEach(function (row) {
                    aoa.push(DATA_KEYS.map(function (k) { return row[k] || ''; }));
                });

                var ws = XLSX.utils.aoa_to_sheet(aoa);
                var range = XLSX.utils.decode_range(ws['!ref']);
                var headerStyle = {
                    font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 11 },
                    fill: { fgColor: { rgb: '1B3A6B' } },
                    alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                    border: { top: { style: 'thin', color: { rgb: '000000' } }, bottom: { style: 'thin', color: { rgb: '000000' } }, left: { style: 'thin', color: { rgb: '000000' } }, right: { style: 'thin', color: { rgb: '000000' } } }
                };
                var cellStyle = {
                    alignment: { horizontal: 'center', vertical: 'center' },
                    border: { top: { style: 'thin', color: { rgb: '000000' } }, bottom: { style: 'thin', color: { rgb: '000000' } }, left: { style: 'thin', color: { rgb: '000000' } }, right: { style: 'thin', color: { rgb: '000000' } } }
                };
                for (var C = range.s.c; C <= range.e.c; C++) {
                    var hAddr = XLSX.utils.encode_cell({ r: 0, c: C });
                    if (ws[hAddr]) ws[hAddr].s = headerStyle;
                    for (var R = 1; R <= range.e.r; R++) {
                        var addr = XLSX.utils.encode_cell({ r: R, c: C });
                        if (ws[addr]) ws[addr].s = cellStyle;
                    }
                }
                ws['!cols'] = DATA_KEYS.map(function (k) {
                    var hdr = HEADER_MAP[k] || k;
                    var mx = hdr.length;
                    data.forEach(function (r) { var v = String(r[k] || ''); if (v.length > mx) mx = v.length; });
                    return { wch: Math.min(mx + 2, 45) };
                });

                var wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Drives');
                XLSX.writeFile(wb, 'cdm_drives_' + new Date().toISOString().slice(0, 10) + '.xlsx');
            });

            /* ══════════════════════════════════════════════════════
               CDM COMPANY SEARCH
               ══════════════════════════════════════════════════════ */
            var searchTimer = null;
            var $searchInput = $('#globalSearch');
            var $searchResults = $('#globalSearchResults');

            $searchInput.off('input').on('input', function () {
                var q = $(this).val().trim();
                clearTimeout(searchTimer);
                if (q.length < 2) { $searchResults.hide().empty(); return; }
                searchTimer = setTimeout(function () {
                    $.getJSON('/api/cdm/search?q=' + encodeURIComponent(q), function (res) {
                        if (!res.results || res.results.length === 0) {
                            $searchResults.html('<div class="gs-empty">No companies found</div>').show();
                            return;
                        }
                        var seen = {};
                        var html = '';
                        res.results.forEach(function (r) {
                            if (seen[r.company_id]) return;
                            seen[r.company_id] = true;
                            var badge = '';
                            if (r.status) {
                                var cls = r.status === 'Completed' ? 'bg-success' :
                                    r.status === 'Ongoing' ? 'bg-warning text-dark' : 'bg-info';
                                badge = '<span class="badge ' + cls + ' ms-2" style="font-size:0.65rem;">' + r.status + '</span>';
                            }
                            html += '<a class="gs-item" href="/cdm/company/' + encodeURIComponent(r.company_id) + '">';
                            html += '<div class="gs-name">' + (r.company_name || '') + badge + '</div>';
                            html += '<div class="gs-meta">' + r.company_id + (r.role ? ' &middot; ' + r.role : '') + '</div>';
                            html += '</a>';
                        });
                        $searchResults.html(html).show();
                    });
                }, 250);
            });

            $(document).on('click', function (e) {
                if (!$(e.target).closest('.global-search-wrap').length) $searchResults.hide();
            });
            $searchInput.on('focus', function () {
                if ($searchResults.children().length && $(this).val().trim().length >= 2) $searchResults.show();
            });

            /* ══════════════════════════════════════════════════════
               CALENDAR TAB
               ══════════════════════════════════════════════════════ */
            var calendarLoaded = false;
            var calEvents = [];
            var calMonth = new Date().getMonth();
            var calYear = new Date().getFullYear();
            var MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];

            function renderCalendar() {
                var $grid = $('#calendarGrid');
                $grid.empty();
                $('#calMonthLabel').text(MONTH_NAMES[calMonth] + ' ' + calYear);

                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(function (d) {
                    $grid.append('<div class="cal-header">' + d + '</div>');
                });

                var firstDay = new Date(calYear, calMonth, 1).getDay();
                var daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();

                for (var e = 0; e < firstDay; e++) {
                    $grid.append('<div class="cal-cell cal-empty"></div>');
                }

                for (var d = 1; d <= daysInMonth; d++) {
                    var dateStr = calYear + '-' + String(calMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                    var dayEvents = calEvents.filter(function (ev) { return ev.process_date === dateStr; });
                    var html = '<div class="cal-cell' + (dayEvents.length ? ' cal-has-event' : '') + '">';
                    html += '<div class="cal-day-num">' + d + '</div>';
                    dayEvents.forEach(function (ev) {
                        var st = (ev.status || 'Upcoming').toLowerCase();
                        var cls = st === 'completed' ? 'cal-evt-completed' :
                            st === 'ongoing' ? 'cal-evt-ongoing' :
                                st === 'cancelled' ? 'cal-evt-cancelled' : 'cal-evt-upcoming';
                        html += '<div class="cal-event ' + cls + '" title="' + ev.company_name + ' - ' + (ev.role || '') + '">';
                        html += '<span class="cal-evt-company">' + ev.company_name + '</span>';
                        if (ev.role) html += '<span class="cal-evt-role">' + ev.role + '</span>';
                        html += '</div>';
                    });
                    html += '</div>';
                    $grid.append(html);
                }
            }

            $('#calPrev').on('click', function () {
                calMonth--;
                if (calMonth < 0) { calMonth = 11; calYear--; }
                renderCalendar();
            });
            $('#calNext').on('click', function () {
                calMonth++;
                if (calMonth > 11) { calMonth = 0; calYear++; }
                renderCalendar();
            });

            $('#calendar-tab').on('shown.bs.tab', function () {
                if (calendarLoaded) return;
                calendarLoaded = true;
                $.getJSON('/api/cdm/calendar', function (data) {
                    calEvents = data.events || [];
                    if (calEvents.length) {
                        var latest = calEvents[calEvents.length - 1].process_date;
                        var parts = latest.split('-');
                        calYear = parseInt(parts[0]);
                        calMonth = parseInt(parts[1]) - 1;
                    }
                    renderCalendar();
                });
            });

            /* ══════════════════════════════════════════════════════
               PLACEMENT SOURCES TAB
               ══════════════════════════════════════════════════════ */
            var sourcesLoaded = false;

            $('#sources-tab').on('shown.bs.tab', function () {
                if (sourcesLoaded) return;
                sourcesLoaded = true;
                $.getJSON('/api/cdm/placement-sources', function (data) {
                    if (data.error) { console.error(data.error); return; }
                    var sources = data.sources || [];

                    var totalPlaced = sources.reduce(function (s, r) { return s + r.placed_count; }, 0);
                    var statsHtml = '';
                    statsHtml += '<div class="stat-card stat-card--accent"><div class="stat-label">Total Placed</div><div class="stat-value">' + totalPlaced + '</div></div>';
                    statsHtml += '<div class="stat-card"><div class="stat-label">Recruiting Companies</div><div class="stat-value">' + sources.length + '</div></div>';
                    $('#sourceStats').html(statsHtml);

                    var $tbody = $('#sourcesTable tbody').empty();
                    sources.forEach(function (s) {
                        $tbody.append(
                            '<tr><td>' + s.company_name + '</td>' +
                            '<td>' + s.placed_count + '</td>' +
                            '<td>' + (s.avg_ctc || '—') + '</td>' +
                            '<td>' + (s.max_ctc || '—') + '</td>' +
                            '<td>' + (s.courses || '—') + '</td></tr>'
                        );
                    });

                    var CC = ['#e53935', '#42a5f5', '#66bb6a', '#ffa726', '#ab47bc',
                        '#26c6da', '#ef5350', '#7e57c2', '#8d6e63', '#78909c'];

                    var top10 = sources.slice(0, 10);
                    if (top10.length) {
                        new Chart($('#chartSources')[0], {
                            type: 'bar',
                            data: {
                                labels: top10.map(function (s) { return s.company_name; }),
                                datasets: [{ label: 'Students Placed', data: top10.map(function (s) { return s.placed_count; }), backgroundColor: CC.slice(0, top10.length) }]
                            },
                            options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                        });
                    }

                    var ctcSources = sources.filter(function (s) { return s.avg_ctc && s.avg_ctc > 0; }).slice(0, 10);
                    if (ctcSources.length) {
                        new Chart($('#chartSourceCTC')[0], {
                            type: 'bar',
                            data: {
                                labels: ctcSources.map(function (s) { return s.company_name; }),
                                datasets: [{ label: 'Avg CTC', data: ctcSources.map(function (s) { return s.avg_ctc; }), backgroundColor: '#42a5f5' }]
                            },
                            options: { indexAxis: 'y', plugins: { legend: { display: false } } }
                        });
                    }
                });
            });

            /* ══════════════════════════════════════════════════════
               ADD COMPANY
               ══════════════════════════════════════════════════════ */
            $('#btnAddCompany').on('click', function () {
                $('#newCompanyName').val('').removeClass('is-invalid');
                $('#addCompanyError').addClass('d-none');
                new bootstrap.Modal('#addCompanyModal').show();
                setTimeout(function () { $('#newCompanyName').focus(); }, 300);
            });

            $('#btnConfirmAddCompany').on('click', function () {
                var name = $('#newCompanyName').val().trim();
                if (!name) {
                    $('#newCompanyName').addClass('is-invalid').focus();
                    return;
                }
                $.ajax({
                    url: '/api/cdm/company',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ company_name: name }),
                    success: function (res) {
                        if (res.ok) {
                            bootstrap.Modal.getInstance('#addCompanyModal').hide();
                            showToast('Company "' + res.company_name + '" created', 'success');
                            COMPANIES_DATA.push({ company_id: res.company_id, company_name: res.company_name, drive_count: 0 });
                            renderCompanies();
                            $('#companiesListWrap').slideDown(200);
                            $('#toggleCompaniesText').text('Hide');
                            window.open('/cdm/company/' + encodeURIComponent(res.company_id), '_blank');
                        } else {
                            $('#addCompanyError').text(res.error || 'Error').removeClass('d-none');
                        }
                    },
                    error: function (xhr) {
                        var msg = 'Create failed';
                        try { msg = JSON.parse(xhr.responseText).error || msg; } catch (e) { }
                        $('#addCompanyError').text(msg).removeClass('d-none');
                    }
                });
            });

            $('#newCompanyName').on('keydown', function (e) {
                if (e.key === 'Enter') $('#btnConfirmAddCompany').click();
            });

        });
    </script>
</body>

</html>